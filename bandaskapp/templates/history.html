{% extends 'base.html' %}

{% block title %}Temperature History - BandaskApp{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4" style="color: #00ff00;">DHW Top Temperature History</h2>
            
            <!-- Time Range Controls -->
            <div class="row mb-3">
                <div class="col-12 text-center">
                    <div class="btn-group" role="group" aria-label="Time range controls">
                        <button type="button" class="btn btn-outline-warning" onclick="decreaseHours()">-1h</button>
                        <button type="button" class="btn btn-info" disabled>
                            <span id="hours-display">1</span> hour(s)
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="increaseHours()">+1h</button>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Controls the time window for MIN/MAX calculation (all data points are displayed)
                    </small>
                </div>
            </div>
            
            <!-- Temperature History Chart -->
            <div class="temperature-history-container">
                <div class="temperature-history">
                    <h6 class="text-center mb-3" style="color: #00ff00;" id="chart-title">
                        DHW Top Temperature - All Data Points with 1-Hour MIN/MAX Windows
                    </h6>
                    <canvas id="tempChart" width="800" height="400"></canvas>
                </div>
            </div>
            
            <!-- Chart Info -->
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <small class="text-muted">
                        The filled area shows the temperature range between MAX and MIN values for each 1-hour period
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status Alert -->
{% if not api_connected %}
<div class="alert alert-danger api-disconnected" role="alert">
    <strong>⚠️ API Connection Lost!</strong> Cannot communicate with hardware. 
    Last successful connection: {{ last_reading|default:"Unknown" }}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let currentHours = 1;
    let tempChart;
    
    // Initialize chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('tempChart').getContext('2d');
        
        // Create chart with temperature range visualization
        tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'DHW Top - MIN (base line)',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    tension: 0.1,
                    fill: '+1',
                    pointRadius: 4,
                    pointHoverRadius: 6
                }, {
                    label: 'DHW Top - MAX (fills to MIN)',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    tension: 0.1,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff',
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                return `Hour: ${context[0].label}`;
                            },
                            label: function(context) {
                                const dataset = context.dataset;
                                const value = context.parsed.y;
                                const type = dataset.label.includes('MAX') ? 'MAX' : 'MIN';
                                return `${type}: ${value.toFixed(1)}°C`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (Hours)',
                            color: '#cccccc'
                        },
                        ticks: {
                            color: '#cccccc',
                            maxTicksLimit: 12
                        },
                        grid: {
                            color: '#444444'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (°C)',
                            color: '#cccccc'
                        },
                        ticks: {
                            color: '#cccccc'
                        },
                        grid: {
                            color: '#444444'
                        },
                        suggestedMin: 15,
                        suggestedMax: 95
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        // Load initial data
        loadTemperatureHistory();
    });
    
    // Time range control functions
    function decreaseHours() {
        if (currentHours > 1) {
            currentHours--;
            updateHoursDisplay();
            loadTemperatureHistory();
        }
    }
    
    function increaseHours() {
        if (currentHours < 24) {
            currentHours++;
            updateHoursDisplay();
            loadTemperatureHistory();
        }
    }
    
    function updateHoursDisplay() {
        document.getElementById('hours-display').textContent = currentHours;
        document.getElementById('chart-title').textContent = 
            `DHW Top Temperature - All Data Points with ${currentHours}-Hour MIN/MAX Windows`;
    }
    
    // Function to load hourly MAX/MIN temperature data
    async function loadTemperatureHistory() {
        try {
            const response = await fetch(`/api/temperature-history-hourly/?hours=${currentHours}`);
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.history) {
                    // Update chart with hourly MAX/MIN data
                    tempChart.data.labels = data.history.labels;
                    tempChart.data.datasets[0].data = data.history.min_values;
                    tempChart.data.datasets[1].data = data.history.max_values;
                    tempChart.update();
                    
                    console.log(`Loaded ${currentHours} hour(s) of temperature data`);
                }
            }
        } catch (error) {
            console.error('Error loading temperature history:', error);
        }
    }
    
    // Update chart data every 5 seconds
    setInterval(loadTemperatureHistory, 5000);
</script>
{% endblock %}

