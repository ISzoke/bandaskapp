{% extends 'base.html' %}

{% block content %}
<div class="row h-100">
    <div class="col-12">
        <h2 class="text-center mb-4" style="color: #00ff00;">‚öôÔ∏è System Settings</h2>
        <p class="text-center text-muted mb-4">Configure BandaskApp parameters</p>
    </div>
</div>



<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>üóÑÔ∏è Data Management</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 style="color: #00ff00;">Mini-Graph Data</h5>
                        <p style="color: #cccccc;">Mini-graphs store temperature history data in your browser's localStorage to persist across page refreshes and browser restarts.</p>
                        <ul style="color: #cccccc;">
                            <li>Data is automatically saved every 30 seconds</li>
                            <li>Data persists for up to 1 hour</li>
                            <li>Includes temperature readings and zoom levels</li>
                            <li>Stored locally in your browser</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5 style="color: #ff6b6b;">Clear Data</h5>
                        <p style="color: #cccccc;">Click the button below to clear all mini-graph data from localStorage. This will reset all graphs to empty state.</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger control-button" onclick="clearMiniGraphData()">
                                <strong>üóëÔ∏è Clear Mini-Graph Data</strong>
                            </button>
                            <small class="text-muted">This action cannot be undone!</small>
                        </div>
                    </div>
                </div>
                
                <!-- Database History Management -->
                <hr style="border-color: #444444; margin: 30px 0;">
                <div class="row">
                    <div class="col-md-6">
                        <h5 style="color: #ff4444;">üóÑÔ∏è Database History</h5>
                        <p style="color: #cccccc;">Database stores system logs, temperature readings, and other historical data. This data is used for system monitoring and debugging.</p>
                        <ul style="color: #cccccc;">
                            <li>System logs and events</li>
                            <li>Temperature sensor readings</li>
                            <li>Control system state changes</li>
                            <li>Error and warning messages</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5 style="color: #ff4444;">Clear Database History</h5>
                        <p style="color: #cccccc;">Click the button below to permanently delete all historical data from the database. This will reset all logs and history.</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger control-button" onclick="clearDatabaseHistory()">
                                <strong>üóëÔ∏è Clear Database History</strong>
                            </button>
                            <small class="text-muted">‚ö†Ô∏è This action cannot be undone and will permanently delete all historical data!</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hardware Values Card -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>üîå Hardware Values</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Thermometers -->
                    <div class="col-md-6">
                        <h5 style="color: #00ff00;">üå°Ô∏è Thermometers</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-sm">
                                <thead>
                                    <tr>
                                        <th style="color: #00ff00;">Circuit ID</th>
                                        <th style="color: #00ff00;">Label</th>
                                        <th style="color: #00ff00;">Value</th>
                                        <th style="color: #00ff00;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for thermometer in thermometers %}
                                    <tr>
                                        <td style="color: #cccccc;">{{ thermometer.id }}</td>
                                        <td style="color: #cccccc;">{{ thermometer.label }}</td>
                                        <td style="color: #cccccc;">
                                            {% if thermometer.id != 'NONE' %}
                                                {% if thermometer.index == 0 %}
                                                    {{ dhw_temp|floatformat:1 }}¬∞C
                                                {% elif thermometer.index == 1 %}
                                                    {{ dhw_temp_2|floatformat:1 }}¬∞C
                                                {% elif thermometer.index == 2 %}
                                                    {{ dhw_temp_3|floatformat:1 }}¬∞C
                                                {% endif %}
                                            {% else %}
                                                <span style="color: #666666;">Disabled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if thermometer.id != 'NONE' %}
                                                {% if thermometer.index == 0 %}
                                                    <span class="badge {% if dhw_sensor_online %}bg-success{% else %}bg-danger{% endif %}">
                                                        {% if dhw_sensor_online %}Online{% else %}Offline{% endif %}
                                                    </span>
                                                {% elif thermometer.index == 1 %}
                                                    <span class="badge {% if dhw_sensor_2_online %}bg-success{% else %}bg-danger{% endif %}">
                                                        {% if dhw_sensor_2_online %}Online{% else %}Offline{% endif %}
                                                    </span>
                                                {% elif thermometer.index == 2 %}
                                                    <span class="badge {% if dhw_sensor_3_online %}bg-success{% else %}bg-danger{% endif %}">
                                                        {% if dhw_sensor_3_online %}Online{% else %}Offline{% endif %}
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Relays and Digital Inputs -->
                    <div class="col-md-6">
                        <h5 style="color: #00ff00;">‚ö° Relays & Digital Inputs</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-sm">
                                <thead>
                                    <tr>
                                        <th style="color: #00ff00;">Type</th>
                                        <th style="color: #00ff00;">Circuit ID</th>
                                        <th style="color: #00ff00;">Value</th>
                                        <th style="color: #00ff00;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Furnace Relay -->
                                    <tr>
                                        <td style="color: #cccccc;">RO (Relay)</td>
                                        <td style="color: #cccccc;">{{ furnace_relay_id|default:"1_01" }}</td>
                                        <td style="color: #cccccc;">
                                            <span class="badge {% if furnace_running %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if furnace_running %}ON{% else %}OFF{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if api_connected %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if api_connected %}Connected{% else %}Disconnected{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Pump Relay -->
                                    <tr>
                                        <td style="color: #cccccc;">RO (Relay)</td>
                                        <td style="color: #cccccc;">{{ pump_relay_id|default:"1_02" }}</td>
                                        <td style="color: #cccccc;">
                                            <span class="badge {% if pump_running %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if pump_running %}ON{% else %}OFF{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if api_connected %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if api_connected %}Connected{% else %}Disconnected{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Heating Control Unit -->
                                    <tr>
                                        <td style="color: #cccccc;">DI (Digital Input)</td>
                                        <td style="color: #cccccc;">{{ heating_control_unit_id|default:"1_01" }}</td>
                                        <td style="color: #cccccc;">
                                            <span class="badge {% if heating_controller_state %}bg-success{% else %}bg-warning{% endif %}">
                                                {% if heating_controller_state %}ON{% else %}OFF{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if api_connected %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if api_connected %}Connected{% else %}Disconnected{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Control IDs Information -->
                        <div class="mt-3">
                            <h6 style="color: #00ff00;">üéØ Control IDs</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small style="color: #cccccc;">
                                        <strong>DHW Control:</strong> {{ control_dhw_id|default:"NONE" }}
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small style="color: #cccccc;">
                                        <strong>HHW Control:</strong> {{ control_hhw_id|default:"NONE" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>


function clearMiniGraphData() {
    if (confirm('Are you sure you want to clear all mini-graph data? This action cannot be undone and will reset all graphs to empty state.')) {
        try {
            // Clear localStorage data
            localStorage.removeItem('bandaskapp_mini_graph_data');
            localStorage.removeItem('bandaskapp_mini_graph_timestamp');
            
            // Show success message
            alert('Mini-graph data has been cleared successfully! All graphs will be reset to empty state when you return to the dashboard.');
            
            debug('Mini-graph localStorage data cleared by user');
        } catch (error) {
            error('Error clearing mini-graph data:', error);
            alert('Error clearing data: ' + error.message);
        }
    }
}

function clearDatabaseHistory() {
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL historical data from the database!\n\nThis includes:\n‚Ä¢ All system logs\n‚Ä¢ Temperature sensor readings\n‚Ä¢ Control system state changes\n‚Ä¢ Error and warning messages\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to proceed?')) {
        try {
            // Show loading state
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<strong>üóëÔ∏è Clearing...</strong>';
            button.disabled = true;
            
            // Make API call to clear database history
            fetch('/api/settings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'clear_database_history'
                })
            })
            .then(response => {
                debug('Response status:', response.status);
                debug('Response headers:', response.headers);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Response is not JSON, get text to see what it actually is
                    return response.text().then(text => {
                        error('Non-JSON response received:', text);
                        throw new Error(`Server returned non-JSON response (${response.status}): ${text.substring(0, 200)}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                debug('Response data:', data);
                if (data.success) {
                    alert('‚úÖ Database history has been cleared successfully!\n\nAll historical data has been permanently deleted from the database.');
                    debug('Database history cleared by user');
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                error('Error clearing database history:', error);
                alert('‚ùå Error clearing database history: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            });
        } catch (error) {
            error('Error in clearDatabaseHistory function:', error);
            alert('Error: ' + error.message);
            // Restore button state on error
            const button = event.target.closest('button');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}


